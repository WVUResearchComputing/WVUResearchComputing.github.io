

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Parallel Programming: OpenACC &mdash; WVU-RC 2023.01.22 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Parallel Programming: CUDA" href="510.CUDA.html" />
    <link rel="prev" title="Parallel Programming: MPI" href="508.MPI.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> WVU-RC
          

          
            
            <img src="../_static/ResearchComputing.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2023.01
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="10.Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="20.QuickStart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="30.BasicUsage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="40.AdvancedUsage.html">Advanced Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="500.ScientificProgramming.html">Scientific Programming</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="501.Fortran_C_CPP.html">Fortran, C and C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="502.Python.html">Python Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="503.R.html">R Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="504.Julia.html">Julia Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="505.Matlab.html">MATLAB</a></li>
<li class="toctree-l2"><a class="reference internal" href="506.Perl.html">Perl Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="507.OpenMP.html">Parallel Programming: OpenMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="508.MPI.html">Parallel Programming: MPI</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Parallel Programming: OpenACC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#openacc">OpenACC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#compiler-with-openacc-support">Compiler with OpenACC support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#submit-a-job-interactively">Submit a job interactively</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-from-the-xsede-workshop-on-openacc">Example from the XSEDE workshop on OpenACC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="510.CUDA.html">Parallel Programming: CUDA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="600.SoftAdmin.html">Software Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="70.DomainSpecific.html">Domain Specific Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="80.ClusterSpecific.html">Clusters Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="90.References.html">References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WVU-RC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="500.ScientificProgramming.html">Scientific Programming</a> &raquo;</li>
        
      <li>Parallel Programming: OpenACC</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/text/509.OpenACC.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="parallel-programming-openacc">
<span id="sp-openacc"></span><h1>Parallel Programming: OpenACC<a class="headerlink" href="#parallel-programming-openacc" title="Permalink to this headline">¶</a></h1>
<p>The fastest supercomputers today include alongside with the normal CPUs, extra electronic devices specialized to perform certain computational tasks much faster than CPUs, those devices are called Accelerators and the most prominent of those today are Graphical Processing Units (GPUs).</p>
<p>Accelerators typically have their own memory and programming those devices requires being aware of memory management and data movement. The memory on Accelerators is usually smaller than the RAM available on compute nodes and the transfer of data from RAM to the internal memory of the accelerator is usually one order of magnitude slower than between RAM and the CPU.</p>
<p>As GPUs are the most common accelerator today and those are the devices on our clusters we will concentrate the rest of this section to them.
We will present two solutions for programming GPUs. OpenACC is a directive based standard for parallel computing with GPUs from several vendors, Intel’s Xeon Phi (Discontinued in 2020), Field-programmable gate arrays (FPGAs), and exotic devices such as Digital Signal Processors (DSPs). We will present how to use OpenACC using the NVIDIA HPC SDK.</p>
<p>For the specific case of NVIDIA GPUs is the solution for parallel computing . CUDA is a platform and application programming interface (API) model created by Nvidia for their GPUs, the API have evolved over the years and several libraries have been created to take advantage of those GPUS. On our clusters we have NVIDIA GPUs and we will present how to compile and run basic programs written in CUDA.</p>
<section id="openacc">
<h2>OpenACC<a class="headerlink" href="#openacc" title="Permalink to this headline">¶</a></h2>
<p>OpenACC is a directive based standard to allow developers to take advantage of various kinds of accelerators such as GPUs from NVIDIA. As being a directive base approach it is similar to OpenMP that we saw in a previous section. All that is needed is to add some directives tothe original source code in such a way that a OpenACC aware compiler can use those directives to parallelize certain portions of the code. The compiler will generate parallel multithreaded code similar to OpenMP but with the addition of data movement in and out the device as most accelerators will have their own memory and data must be transferred before the accelerator can process that data. For compilers that are not OpenACC capable, will simply ignore those directives and compile a serial code as usual.</p>
<section id="compiler-with-openacc-support">
<h3>Compiler with OpenACC support<a class="headerlink" href="#compiler-with-openacc-support" title="Permalink to this headline">¶</a></h3>
<p>The best set of compilers for using OpenACC is the NVIDIA HPC SDK. There is support from GNU Compiler Collection (GCC) starting from GCC 8 that supports OpenACC 2.0 up to GCC 10 that supports OpenACC 2.6. For this section we will use the NVIDIA HPC SDK compilers. To load the compilers execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">lang</span><span class="o">/</span><span class="n">nvidia</span><span class="o">/</span><span class="n">nvhpc</span>
</pre></div>
</div>
<p>Now that you have loaded the module, the three compilers that you can use for OpenACC are <cite>nvfortran</cite>, <cite>nvc</cite> and <cite>nvc++</cite> for Fortran, C and C++ respectively.</p>
</section>
<section id="submit-a-job-interactively">
<h3>Submit a job interactively<a class="headerlink" href="#submit-a-job-interactively" title="Permalink to this headline">¶</a></h3>
<p>You do not need to compile the code on a compute node with GPUs, but for the purpose of learning is good to work directly on an interactive node and test executions and recompile as needed.</p>
<p>The command to request one GPU card for an interactive job is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; qsub -I -l nodes=1:ppn=8:gpus=1 -q comm_gpu_inter
</pre></div>
</div>
<p>Now, lets start with a very simple example. Consider the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include  &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;limits.h&gt;</span>
<span class="c1">#include &lt;math.h&gt;</span>

<span class="o">//</span> <span class="n">LONG</span> <span class="n">MAX</span> <span class="mi">9223372036854775807</span>
<span class="c1">#define N            1000000000</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>

<span class="n">double</span> <span class="n">pi</span><span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">long</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span><span class="n">nmax</span><span class="p">;</span>

<span class="n">nmax</span><span class="o">=</span><span class="p">(</span><span class="n">long</span> <span class="nb">int</span><span class="p">)(</span><span class="n">LONG_MAX</span><span class="o">/</span><span class="n">N</span><span class="p">);</span>

<span class="c1">#pragma acc kernels</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">long</span> <span class="nb">int</span><span class="p">)</span><span class="n">nmax</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">double</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">double</span><span class="p">)((</span><span class="n">i</span><span class="o">+</span><span class="mf">0.05</span><span class="p">)</span><span class="o">/</span><span class="n">nmax</span><span class="p">);</span>
  <span class="n">pi</span> <span class="o">+=</span> <span class="mf">4.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">printf</span><span class="p">(</span><span class="s2">&quot;PI using </span><span class="si">%ld</span><span class="s2"> terms in the series is equal to </span><span class="si">%20.15le</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">pi</span><span class="o">/</span><span class="n">nmax</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Difference with reference value </span><span class="si">%e</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">fabs</span><span class="p">(</span><span class="n">M_PI</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="n">nmax</span><span class="p">));</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Notice that we are using the a line with the pragma:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#pragma acc kernels</span>
</pre></div>
</div>
<p>That line, instructs a compiler with support for OpenACC that the block of code after the pragma, ie, the for loop, could be parallelized. Lets first compile the code without requesting OpenACC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; nvc pi_acc_d.c
</pre></div>
</div>
<p>After the code is compile the executable by default is the file <cite>a.out</cite>. We can execute this file and timing the execution with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; time ./a.out
PI using 9223372036 terms in the series is equal to 3.141592653687312e+00
Difference with reference value 9.751933e-11

real    0m24.704s
user    0m24.643s
sys     0m0.003s
</pre></div>
</div>
<p>On the current machine, it takes more than 20 seconds to compute all the series. Now lets compile again using the arguments to <cite>nvc</cite> and ask it to introduce OpenACC for the pragma in the sources:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; nvc pi_acc_d.c -acc -Minfo=all
</pre></div>
</div>
<p>With the addition of <cite>-Minfo=all</cite> we will get some extra information about which portions of the code will be parallelized and how. Repeat the execution for the new binary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; time ./a.out
PI using 9223372036 terms in the series is equal to 3.141592653687371e+00
Difference with reference value 9.757795e-11

real    0m1.922s
user    0m0.399s
sys     0m1.459s
</pre></div>
</div>
<p>You will observe that it takes less than 2 seconds, a very significant improvement over the serial version.</p>
</section>
<section id="example-from-the-xsede-workshop-on-openacc">
<h3>Example from the XSEDE workshop on OpenACC<a class="headerlink" href="#example-from-the-xsede-workshop-on-openacc" title="Permalink to this headline">¶</a></h3>
<p>Now, we will show how to compile and execute the same code proposed during the XSEDE workshop on OpenACC. To compile the serial code for the fortran example use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; nvfortran laplace_serial.f90
</pre></div>
</div>
<p>Execute the code with a limit of 4000 iterations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; echo 4000 | time ./a.out
</pre></div>
</div>
<p>The final lines from the execution are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">----------</span> <span class="n">Iteration</span> <span class="n">number</span><span class="p">:</span>          <span class="mi">3300</span>  <span class="o">---------------</span>
<span class="p">(</span> <span class="mi">995</span><span class="p">,</span> <span class="mi">995</span><span class="p">):</span> <span class="mf">97.66</span>  <span class="p">(</span> <span class="mi">996</span><span class="p">,</span> <span class="mi">996</span><span class="p">):</span> <span class="mf">98.24</span>  <span class="p">(</span> <span class="mi">997</span><span class="p">,</span> <span class="mi">997</span><span class="p">):</span> <span class="mf">98.75</span>  <span class="p">(</span> <span class="mi">998</span><span class="p">,</span> <span class="mi">998</span><span class="p">):</span> <span class="mf">99.19</span>  <span class="p">(</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">):</span> <span class="mf">99.56</span>  <span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span> <span class="mf">99.87</span>
<span class="n">Max</span> <span class="n">error</span> <span class="n">at</span> <span class="n">iteration</span>          <span class="mi">3372</span>  <span class="n">was</span>    <span class="mf">9.9953310357534519E-003</span>
<span class="n">Total</span> <span class="n">time</span> <span class="n">was</span>     <span class="mf">17.64035</span>      <span class="n">seconds</span><span class="o">.</span>
<span class="mf">17.59</span><span class="n">user</span> <span class="mf">0.00</span><span class="n">system</span> <span class="mi">0</span><span class="p">:</span><span class="mf">17.64</span><span class="n">elapsed</span> <span class="mi">99</span><span class="o">%</span><span class="n">CPU</span> <span class="p">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="o">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">18484</span><span class="n">maxresident</span><span class="p">)</span><span class="n">k</span>
<span class="mi">0</span><span class="n">inputs</span><span class="o">+</span><span class="mi">0</span><span class="n">outputs</span> <span class="p">(</span><span class="mi">0</span><span class="n">major</span><span class="o">+</span><span class="mi">5181</span><span class="n">minor</span><span class="p">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
</pre></div>
</div>
<p>Now, lets compile the solution proposed during the workshop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; nvfortran laplace_acc.f90 -acc -Minfo=all
serial:
     44, Generating copy(temperature_last(:,:)) [if not already present]
         Generating create(temperature(:,:)) [if not already present]
     48, Loop is parallelizable
     49, Loop is parallelizable
         Generating Tesla code
         48, !$acc loop gang, vector(4) ! blockidx%y threadidx%y
         49, !$acc loop gang, vector(32) ! blockidx%x threadidx%x
     59, Generating implicit copy(dt) [if not already present]
     60, Loop is parallelizable
     61, Loop is parallelizable
         Generating Tesla code
         60, !$acc loop gang, vector(4) ! blockidx%y threadidx%y
             Generating implicit reduction(max:dt)
         61, !$acc loop gang, vector(32) ! blockidx%x threadidx%x
     70, Generating update self(temperature(:,:))
initialize:
     98, Memory zero idiom, array assignment replaced by call to pgf90_mzero8
</pre></div>
</div>
<p>And test the new binary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">----------</span> <span class="n">Iteration</span> <span class="n">number</span><span class="p">:</span>          <span class="mi">3300</span>  <span class="o">---------------</span>
<span class="p">(</span> <span class="mi">995</span><span class="p">,</span> <span class="mi">995</span><span class="p">):</span> <span class="mf">97.66</span>  <span class="p">(</span> <span class="mi">996</span><span class="p">,</span> <span class="mi">996</span><span class="p">):</span> <span class="mf">98.24</span>  <span class="p">(</span> <span class="mi">997</span><span class="p">,</span> <span class="mi">997</span><span class="p">):</span> <span class="mf">98.75</span>  <span class="p">(</span> <span class="mi">998</span><span class="p">,</span> <span class="mi">998</span><span class="p">):</span> <span class="mf">99.19</span>  <span class="p">(</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">):</span> <span class="mf">99.56</span>  <span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span> <span class="mf">99.87</span>
<span class="n">Max</span> <span class="n">error</span> <span class="n">at</span> <span class="n">iteration</span>          <span class="mi">3372</span>  <span class="n">was</span>    <span class="mf">9.9953310357534519E-003</span>
<span class="n">Total</span> <span class="n">time</span> <span class="n">was</span>     <span class="mf">1.402100</span>      <span class="n">seconds</span><span class="o">.</span>
<span class="mf">0.30</span><span class="n">user</span> <span class="mf">1.32</span><span class="n">system</span> <span class="mi">0</span><span class="p">:</span><span class="mf">01.68</span><span class="n">elapsed</span> <span class="mi">96</span><span class="o">%</span><span class="n">CPU</span> <span class="p">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="o">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">208792</span><span class="n">maxresident</span><span class="p">)</span><span class="n">k</span>
<span class="mi">0</span><span class="n">inputs</span><span class="o">+</span><span class="mi">0</span><span class="n">outputs</span> <span class="p">(</span><span class="mi">0</span><span class="n">major</span><span class="o">+</span><span class="mi">24657</span><span class="n">minor</span><span class="p">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
</pre></div>
</div>
<p>There is a significant improvement in the execution of the Laplace solver on a compute node using one GPU card.</p>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="510.CUDA.html" class="btn btn-neutral float-right" title="Parallel Programming: CUDA" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="508.MPI.html" class="btn btn-neutral float-left" title="Parallel Programming: MPI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, West Virginia University

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>